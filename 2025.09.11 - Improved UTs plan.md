# Improved Unit Test Plan — 2025‑09‑11

## Snapshot (Verified)
- Total: 41 unit tests across workspace; `mdmcpcfg` has 0 tests.
- Strong coverage in `mdmcpsrvr` and shared crates (`mdmcp_policy`, `mdmcp_common`).
- Business logic and platform integration in `mdmcpcfg` are untested.

## Prioritized Goals
- Close the critical gap in `mdmcpcfg` with low‑risk, pure unit tests first.
- Add targeted server tests for policy reload behavior.
- Cover platform detection and WSL handling with `#[cfg(..)]` gated tests.
- Stage higher‑friction flows (network, prompts, process control) behind small seams for deterministic tests.

## Phase 1: Low‑Risk, High‑Value Unit Tests
Add ~20–25 deterministic tests next to the code (Rust convention: `mod tests` in the same file). Use `tempfile`/`tempdir` where FS writes are needed. Gate platform‑specific tests with `#[cfg(..)]`.

### mdmcpcfg I/O and helpers
- `mdmcpcfg/src/io.rs`
  - WSL detection and path mapping:
    - `#[cfg(target_os = "linux")] fn test_windows_path_to_wsl_mount_variants()`
    - `#[cfg(target_os = "linux")] fn test_is_wsl_env_flag()` (set `WSL_INTEROP`/`WSL_DISTRO_NAME` in test env)
  - Claude config path resolution:
    - `#[cfg(target_os = "linux")] fn test_config_path_linux_non_wsl_fallback()`
    - `#[cfg(target_os = "windows")] fn test_config_path_windows_location()`
  - Claude server entry wiring:
    - `fn test_add_mdmcp_server_non_wsl()` → command points to binary, args `--config … --stdio`
    - `#[cfg(target_os = "linux")] fn test_add_mdmcp_server_wsl_args()` → `command == "wsl.exe"`, args include distro and `--stdio`
  - Executable detection:
    - `#[cfg(target_os = "windows")] fn test_is_executable_windows_extension_rules()`
    - `#[cfg(unix)] fn test_is_executable_unix_perm_bits()`

- `mdmcpcfg/src/commands/docs.rs`
  - ANSI stripping:
    - `fn test_strip_ansi_codes()`
  - Cache path join:
    - `fn test_doc_cache_path_join()`

### mdmcpcfg install helpers
- `mdmcpcfg/src/commands/install.rs`
  - Version parsing:
    - `fn test_parse_version_various_patterns()` (e.g., "mdmcpsrvr 1.2.3", "version v0.3.0", "v2.0.0")
  - Platform string shape:
    - `fn test_get_platform_string_shape()` (contains arch and OS tokens)
  - SHA256 hashing:
    - `fn test_calculate_sha256_tempfile()`
  - Default policy content safety:
    - `fn test_default_policy_content_parses_and_has_defaults()` (YAML parses; `version == 1`; `write_rules` non‑empty)
  - Core policy refresh:
    - `fn test_refresh_core_policy_preserves_readonly_flag()` (toggle read‑only in a temp dir; validate overwrite and final read‑only)

### mdmcpcfg policy validation utilities
- `mdmcpcfg/src/commands/policy.rs`
  - Structure validation:
    - `fn test_validate_policy_structure_happy_path()`
    - `fn test_validate_policy_structure_missing_fields()` (expect error)
    - `fn test_validate_policy_structure_duplicate_ids()` (expect error)
  - Summary output (smoke):
    - `fn test_print_policy_summary_small_policy()` (ensures it prints counts without panicking)

### mdmcpsrvr policy reload behavior
- `mdmcpsrvr/src/server.rs`
  - `#[tokio::test] async fn reload_policy_success_rebuilds_catalog()`
  - `#[tokio::test] async fn reload_policy_invalid_yaml_returns_error()`

## Phase 2: Medium‑Risk, With Small Seams
Introduce tiny, module‑private seams to make interactive/network/process logic testable without flakiness. Add ~15–25 tests.

### Install/Update flows (no real network)
- In `install.rs`, add a trait for release metadata + downloads:
  - `trait ReleaseProvider { async fn latest(&self) -> Result<GitHubRelease>; async fn download(&self, name: &str, dest: &Path) -> Result<()> }`
  - Production impl uses the real HTTP client; tests inject an in‑memory/mock provider.
- Tests:
  - `#[tokio::test] async fn test_install_github_success_mocked()`
  - `#[tokio::test] async fn test_update_to_same_version_noop()` (`!force` keeps existing)
  - `#[tokio::test] async fn test_network_failure_surface_error()` (provider returns error)

### Policy edit/workflow commands
- Provide a test‑friendly constructor for paths:
  - `#[cfg(test)] impl Paths { fn for_test(bin: PathBuf, cfg: PathBuf) -> Self { … } }`
- Tests in `policy.rs`:
  - `#[tokio::test] async fn test_add_root_and_write_rule_persistence()`
  - `#[tokio::test] async fn test_add_command_id_uniqueness_error()`
  - `#[tokio::test] async fn test_set_unset_env_for_command()`
  - `#[tokio::test] async fn test_validate_merged_with_core_and_user()`

### Claude Desktop integration
- Add a test‑only override for the config path (env var):
  - In `ClaudeDesktopConfig::config_path()`, under `#[cfg(test)]`, check `MDMCP_TEST_CLAUDE_CONFIG` first.
- Tests:
  - `fn test_claude_config_save_and_roundtrip_with_mdmcp_entry()`
  - `#[cfg(target_os = "linux")] fn test_claude_config_wsl_path_resolution_when_wsl_env_set()`

### Prompts and process control
- Factor prompts behind a tiny input provider:
  - `trait Input { fn read_line(&mut self) -> String }` with a default `StdinInput`.
- Factor Claude start/stop behind a façade:
  - `trait ClaudeCtl { fn stop(&self) -> Result<()>; fn start(&self, prev: Option<&str>) -> Result<()> }`
- Tests:
  - `fn test_prompt_source_choice_parsing()` (inject responses)
  - `#[cfg(target_os = "windows")] fn test_stop_start_claude_dispatches_expected_commands_with_mock()`

## Integration/E2E (Selective)
- Add a single integration test under `tests/` that spawns the server process with a temp policy and exercises a minimal JSON‑RPC stdio roundtrip:
  - `initialize`, `tools/call` for `fs.read` and `cmd.run echo`.
  - Call `reload_policy` and verify catalog updates.
- Keep the Windows `test_new_methods.py` as a manual smoke test; do not gate CI on it.

## Minimal Refactors (Test‑Only or Internal)
- `Paths::for_test(..)` helper (only under `#[cfg(test)]`) to avoid writing to real user dirs.
- `ClaudeDesktopConfig::config_path()` honors `MDMCP_TEST_CLAUDE_CONFIG` in tests.
- Private traits (in `install.rs`) for release metadata/downloads, input, and process control with default prod impls.
- No behavioral changes to production code paths.

## CI
- Matrix: `windows-latest`, `ubuntu-latest`, `macos-latest`.
- Commands:
  - `cargo fmt --all -- --check`
  - `cargo clippy --all-targets --all-features -D warnings`
  - `cargo test --workspace --all-features`
- Gate OS‑specific tests with `#[cfg(..)]` to avoid cross‑platform failures.

## Coverage Targets
- After Phase 1: +20–25 tests → major lift in `mdmcpcfg`’s pure logic; workspace ~70%.
- After Phase 2: +15–25 tests → install/update flows, policy edits, platform seams; workspace ~75–80% with business logic gaps closed.

## Why This Improves The Original Plan
- Maps tests directly to concrete functions and files (surgical, verifiable).
- Starts with deterministic, low‑risk units to land value fast.
- Introduces minimal seams to test complex flows without flakiness.
- Adds important server coverage for policy reload behavior.

## Next Steps
1) Land Phase 1 tests (pure units). 2) Add the tiny seams and implement Phase 2 tests. 3) Add the single stdio integration test. 4) Enable the CI matrix and gating.

