# Example MCP Server Policy Configuration
# This file demonstrates a comprehensive policy configuration for the mdmcp server.
# Adjust paths and commands according to your specific environment and security requirements.

version: 1

# Network filesystem access policy:
#   deny_all       - Block all network filesystems (most secure, default)
#   allow_local_wsl - Allow WSL paths (\\wsl$\..., \\wsl.localhost\...) but block remote shares
#   allow_all      - Allow all network filesystems (least secure)
network_fs_policy: deny_all

# Define allowed root directories for file operations
# All file read/write operations must be within these directories
allowed_roots:
  - "~/code"                    # User code directory
  - "~/Documents/projects"      # Project documents
  - "/tmp/mdmcp-scratch"        # Temporary workspace (Unix)
  - "C:/Temp/mdmcp-scratch"     # Temporary workspace (Windows)

# Write permissions for specific directories
write_rules:
  - path: "~/code/scratch"
    recursive: true
    max_file_bytes: 10000000      # 10MB max file size
    create_if_missing: true

  - path: "/tmp/mdmcp-scratch"
    recursive: true
    max_file_bytes: 5000000       # 5MB max file size
    create_if_missing: true

  - path: "C:/Temp/mdmcp-scratch"
    recursive: true
    max_file_bytes: 5000000       # 5MB max file size
    create_if_missing: true

# Command execution rules
commands:
  # Directory listing (Unix)
  - id: "ls"
    exec: "/bin/ls"
    args:
      allow: ["-l", "-la", "-a", "-h", "-t", "-r"]
    cwd_policy: "within_root"
    env_allowlist: []
    timeout_ms: 5000
    max_output_bytes: 1000000
    platform: ["linux", "macos"]
    allow_any_args: false

  # Directory listing (Windows)
  - id: "dir"
    exec: "C:/Windows/System32/cmd.exe"
    args:
      fixed: ["/c", "dir"]
    cwd_policy: "within_root"
    env_allowlist: []
    timeout_ms: 5000
    max_output_bytes: 1000000
    platform: ["windows"]
    allow_any_args: true

  # File search with ripgrep
  - id: "rg"
    exec: "/usr/bin/rg"
    args:
      allow: ["--vimgrep", "--hidden", "--line-number", "--no-messages", "--max-count"]
      patterns:
        - type: "regex"
          value: "^[\\w\\-\\./@:+#*?\\[\\]\\s]+$"  # Safe search patterns
    cwd_policy: "within_root"
    env_allowlist: ["RIPGREP_CONFIG_PATH"]
    timeout_ms: 30000
    max_output_bytes: 5000000
    platform: ["linux", "macos"]
    allow_any_args: false

  # Git operations (read-only)
  - id: "git"
    exec: "/usr/bin/git"
    args:
      allow: [
        "status", "log", "show", "diff", "rev-parse", "describe",
        "branch", "tag", "remote", "config", "--get"
      ]
    cwd_policy: "within_root"
    env_allowlist: ["GIT_CONFIG_GLOBAL", "GIT_ALLOW_PROTOCOL"]
    timeout_ms: 30000
    max_output_bytes: 5000000
    platform: ["linux", "macos"]
    allow_any_args: false

  # File operations
  - id: "cat"
    exec: "/bin/cat"
    args:
      patterns:
        - type: "regex"
          value: "^[\\w\\-\\./@:+\\s]+$"  # Safe file paths only
    cwd_policy: "within_root"
    env_allowlist: []
    timeout_ms: 10000
    max_output_bytes: 2000000
    platform: ["linux", "macos"]
    allow_any_args: false

  - id: "head"
    exec: "/usr/bin/head"
    args:
      allow: ["-n"]
      patterns:
        - type: "regex"
          value: "^[\\w\\-\\./@:+\\s]+$"  # Safe file paths only
    cwd_policy: "within_root"
    env_allowlist: []
    timeout_ms: 5000
    max_output_bytes: 1000000
    platform: ["linux", "macos"]
    allow_any_args: false

  - id: "tail"
    exec: "/usr/bin/tail"
    args:
      allow: ["-n", "-f"]
      patterns:
        - type: "regex"
          value: "^[\\w\\-\\./@:+\\s]+$"  # Safe file paths only
    cwd_policy: "within_root"
    env_allowlist: []
    timeout_ms: 5000
    max_output_bytes: 1000000
    platform: ["linux", "macos"]
    allow_any_args: false

  # Basic text processing
  - id: "wc"
    exec: "/usr/bin/wc"
    args:
      allow: ["-l", "-w", "-c", "-m"]
      patterns:
        - type: "regex"
          value: "^[\\w\\-\\./@:+\\s]+$"
    cwd_policy: "within_root"
    env_allowlist: []
    timeout_ms: 10000
    max_output_bytes: 100000
    platform: ["linux", "macos"]
    allow_any_args: false

  # Find files (restricted)
  - id: "find"
    exec: "/usr/bin/find"
    args:
      allow: ["-name", "-type", "-maxdepth", "-mindepth", "-newer", "-size"]
      patterns:
        - type: "regex"
          value: "^[\\w\\-\\./@:+*?\\[\\]\\s]+$"
    cwd_policy: "within_root"
    env_allowlist: []
    timeout_ms: 30000
    max_output_bytes: 2000000
    platform: ["linux", "macos"]
    allow_any_args: false

  # PowerShell (Windows) - limited commands
  - id: "powershell-get"
    exec: "C:/Windows/System32/WindowsPowerShell/v1.0/powershell.exe"
    args:
      fixed: ["-Command", "Get-ChildItem"]
    cwd_policy: "within_root"
    env_allowlist: []
    timeout_ms: 10000
    max_output_bytes: 1000000
    platform: ["windows"]
    allow_any_args: true

# Logging configuration
logging:
  level: "info"
  file: "~/.mdmcp/mdmcpsrvr.log.jsonl"
  redact: ["env"]  # Redact environment variables in logs

# Resource limits
limits:
  max_read_bytes: 20000000      # 20MB maximum read size
  max_cmd_concurrency: 3        # Maximum 3 concurrent commands
