# Coverage Improvement Plan

**Target:** 98% Code Coverage
**Current:** ~39%

## Stage 1: Core Security & Policy Logic (High Priority)
Focus on the security-critical components. These are often easier to test because they are more algorithmic.

*   **`crates/mdmcp_policy`**:
    *   Add tests for edge cases in YAML parsing.
    *   Test validation failures for invalid policies (e.g., duplicate IDs, invalid regex).
*   **`mdmcpsrvr/src/fs_safety.rs`**:
    *   Add tests for complex path canonicalization scenarios (Windows vs Unix).
    *   Test `network_fs_policy` exhaustively.
*   **`mdmcpsrvr/src/sandbox.rs`**:
    *   Test all resource limit configurations.
    *   Test environment variable filtering logic.
    *   Mock command execution if possible, or verify command construction logic.

## Stage 2: Server Request Handling
Focus on `mdmcpsrvr/src/server.rs`. This is the "brain" of the MCP server.

*   **Refactor `server.rs`**: Ensure handlers are testable without a full stdio loop if possible, or use the existing `e2e_stdio` pattern but with much more granularity.
*   **Test Cases**:
    *   `fs.read`: File not found, permission denied, file too large, encoding errors.
    *   `fs.write`: Write denied, path outside root, create directory logic.
    *   `cmd.run`: Command not found, arguments denied, timeout, output truncation.
    *   `list_directory`: Access denied, empty directory, large directory.

## Stage 3: Configuration CLI (`mdmcpcfg`)
Focus on `mdmcpcfg`.

*   **`commands/policy.rs`**:
    *   Test `add-root`, `remove-root`, `add-command` with various invalid inputs.
    *   Test `edit` command logic (opening editor - might need mocking).
*   **`commands/install.rs`**:
    *   This is hard to test. We need to mock the "GitHub API" and "File System" calls.
    *   Refactor `install.rs` to accept a trait for "ReleaseSource" and "InstallerIO".

## Stage 4: Plugins
Focus on `plugins/mdaicli` and others.

*   **Mock Providers**: Create a mock struct implementing the AI provider traits to test the CLI loop without real network calls.
*   **Config Loading**: Test all configuration file permutation loading.

## Execution Strategy
I will proceed stage by stage, starting with Stage 1. I will verify coverage after every significant batch of tests.
