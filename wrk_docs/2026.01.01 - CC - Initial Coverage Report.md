# Code Coverage Report - 2026.01.01

**Current Overall Coverage:** 39.39% (Lines)

## Executive Summary
The repository currently has a low overall code coverage of approximately 39%. While some core logic libraries like `mdmcp_common` and parts of `mdmcpsrvr` (e.g., `audit.rs`, `fs_safety.rs`) have decent coverage (>80%), the majority of the CLI command implementations and plugin integrations are severely under-tested.

To reach the target of 98% coverage, a significant effort is required to:
1.  Mock external system interactions (filesystem, network, subprocesses) to test CLI commands.
2.  Add comprehensive unit tests for edge cases in core logic.
3.  Implement integration tests for the `server.rs` request handling loop.

## Detailed Breakdown by Component

### Core Components

| Component | File | Coverage | Notes |
| :--- | :--- | :--- | :--- |
| **Common** | `crates\mdmcp_common\src\lib.rs` | 93.59% | Good coverage. |
| **Policy** | `crates\mdmcp_policy\src\lib.rs` | 65.76% | Needs improvement in validation logic. |
| **Server** | `mdmcpsrvr\src\audit.rs` | 85.14% | Good. |
| | `mdmcpsrvr\src\cmd_catalog.rs` | 79.57% | Good, but can be higher. |
| | `mdmcpsrvr\src\fs_safety.rs` | 82.16% | Security critical, aim for 100%. |
| | `mdmcpsrvr\src\policy.rs` | 83.56% | Good. |
| | `mdmcpsrvr\src\rpc.rs` | 70.04% | RPC parsing needs more error case tests. |
| | `mdmcpsrvr\src\sandbox.rs` | 68.19% | Security critical. Needs substantial improvement. |
| | `mdmcpsrvr\src\server.rs` | 41.74% | **Critical Gap.** Main event loop and handlers. |
| | `mdmcpsrvr\src\main.rs` | 0.00% | Entry point. |

### Configuration CLI (`mdmcpcfg`)

| File | Coverage | Notes |
| :--- | :--- | :--- |
| `src\commands\docs.rs` | 72.67% | Decent. |
| `src\commands\doctor.rs` | 0.00% | **Untested.** |
| `src\commands\doctor_extra.rs` | 0.00% | **Untested.** |
| `src\commands\install.rs` | 20.57% | **Critical Gap.** Complex logic needs mocking. |
| `src\commands\policy.rs` | 59.62% | Needs more edge case testing. |
| `src\io.rs` | 50.91% | I/O helpers need better coverage. |

### Plugins

| Plugin | Component | Coverage | Notes |
| :--- | :--- | :--- | :--- |
| **mdaicli** | `src\providers\openai.rs` | 23.74% | Low. Needs mock server responses. |
| | `src\providers\anthropic.rs` | 51.41% | Better, but still low. |
| | `src\config.rs` | 35.86% | Configuration loading needs tests. |
| **mdconfcli** | `src\main.rs` | 32.97% | Low. |
| **mdjiracli** | `src\main.rs` | 29.58% | Low. |
| **mdmailcli** | `src\main.rs` | 31.23% | Low. |
| **mdslackcli** | `src\main.rs` | 26.45% | Low. |

## Strategy for Improvement

The primary blockers to higher coverage are:
1.  **Side Effects:** Many functions perform direct I/O or system calls.
2.  **Integration Complexity:** Testing the `server` or `install` commands requires setting up complex environments.

**Approach:**
1.  **Refactor for Testability:** Extract logic into pure functions or traits where possible.
2.  **Mocking:** Use internal mocking or dependency injection for file system and network operations.
3.  **Property Testing:** Use property-based testing for policy and parsing logic to cover edge cases.
