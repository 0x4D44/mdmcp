# Microsoft Graph API Extensions Design Proposal
**Date**: 2025-09-12  
**Project**: mdmailcli

## Executive Summary

Extend mdmailcli to support additional Microsoft Graph API services including Teams, Office documents (Word, PowerPoint, Excel), and SharePoint. This leverages the existing authentication and token management infrastructure while adding new command categories.

## Proposed Scope Extensions

### Current Scopes
```
offline_access User.Read 
Mail.Read Mail.ReadWrite Mail.Send 
Calendars.Read Calendars.ReadWrite Calendars.Read.Shared
```

### Proposed Additional Scopes
```
Files.Read Files.ReadWrite 
Sites.Read.All 
Team.ReadBasic.All Channel.ReadBasic.All 
ChannelMessage.Read.All ChannelMessage.Send
Chat.Read Chat.ReadWrite
```

## Command Structure

### 1. Document Operations

#### List Files
```bash
cargo run -- files-list [--folder <path>] [--type <doc|sheet|slide>] [--top <n>]
```

#### Download Document
```bash
cargo run -- files-get <file-id> [--output <path>] [--format <pdf|docx|html>]
```

#### Upload Document
```bash
cargo run -- files-upload <local-path> [--to <remote-path>] [--overwrite]
```

#### Create Document
```bash
cargo run -- files-create --type <word|excel|powerpoint> --name <name> [--folder <path>]
```

#### Search Documents
```bash
cargo run -- files-search --query <text> [--type <doc|sheet|slide>] [--modified-since <date>]
```

### 2. Teams Operations

#### List Teams
```bash
cargo run -- teams-list [--archived <true|false>]
```

#### List Channels
```bash
cargo run -- teams-channels --team <team-name-or-id> [--type <standard|private>]
```

#### Read Channel Messages
```bash
cargo run -- teams-messages --team <team> --channel <channel> [--since <date>] [--top <n>]
```

#### Send Channel Message
```bash
cargo run -- teams-send --team <team> --channel <channel> --message <text> [--html]
```

#### List Chats
```bash
cargo run -- chats-list [--type <oneOnOne|group>] [--top <n>]
```

#### Read Chat Messages
```bash
cargo run -- chats-messages --chat <chat-id> [--since <date>] [--top <n>]
```

#### Send Chat Message
```bash
cargo run -- chats-send --chat <chat-id> --message <text> [--html]
```

### 3. SharePoint Operations

#### List Sites
```bash
cargo run -- sites-list [--search <query>]
```

#### List Document Libraries
```bash
cargo run -- sites-libraries --site <site-name-or-id>
```

#### List Library Contents
```bash
cargo run -- sites-files --site <site> --library <library> [--folder <path>]
```

## Implementation Architecture

### Code Organization

Maintain single-file architecture but add logical sections:

```rust
// src/main.rs structure

// === Core Auth & Config (existing) ===
struct AppConfig { /* extended with new scopes */ }

// === Mail Commands (existing) ===
// Current mail operations

// === Calendar Commands (existing) ===  
// Current calendar operations

// === Document Commands (new) ===
mod docs {
    pub async fn list_files(...) -> Result<()>
    pub async fn download_file(...) -> Result<()>
    pub async fn upload_file(...) -> Result<()>
    pub async fn create_document(...) -> Result<()>
}

// === Teams Commands (new) ===
mod teams {
    pub async fn list_teams(...) -> Result<()>
    pub async fn list_channels(...) -> Result<()>
    pub async fn read_messages(...) -> Result<()>
    pub async fn send_message(...) -> Result<()>
}

// === SharePoint Commands (new) ===
mod sharepoint {
    pub async fn list_sites(...) -> Result<()>
    pub async fn list_libraries(...) -> Result<()>
    pub async fn list_files(...) -> Result<()>
}
```

### API Endpoints

#### Documents/OneDrive
- List files: `GET /me/drive/root/children`
- Get file: `GET /me/drive/items/{item-id}`
- Download: `GET /me/drive/items/{item-id}/content`
- Upload: `PUT /me/drive/root:/{path}:/content`
- Create: `POST /me/drive/root/children`
- Search: `GET /me/drive/search(q='{query}')`

#### Teams
- List teams: `GET /me/joinedTeams`
- List channels: `GET /teams/{team-id}/channels`
- Get messages: `GET /teams/{team-id}/channels/{channel-id}/messages`
- Send message: `POST /teams/{team-id}/channels/{channel-id}/messages`
- List chats: `GET /me/chats`
- Chat messages: `GET /chats/{chat-id}/messages`

#### SharePoint
- Search sites: `GET /sites?search={query}`
- Get site: `GET /sites/{site-id}`
- List libraries: `GET /sites/{site-id}/drives`
- List files: `GET /sites/{site-id}/drives/{drive-id}/root/children`

### Authentication Updates

Modify `init` command to support scope profiles:

```bash
# Basic mail/calendar (current)
cargo run -- init --profile mail

# Full productivity suite
cargo run -- init --profile full

# Teams-focused
cargo run -- init --profile teams

# Custom
cargo run -- init --scopes "..."
```

### Error Handling

Extend error messages for new permission scenarios:
- `403 Forbidden`: Check if required scope is granted
- `404 Not Found`: Validate team/site/file exists
- `429 Too Many Requests`: Implement exponential backoff

## Migration Path

### Phase 1: Foundation (Week 1)
1. Update `AppConfig` to support extended scopes
2. Add scope profiles to `init` command
3. Update help text and documentation

### Phase 2: Document Operations (Week 2)
1. Implement file listing and search
2. Add download/upload capabilities
3. Support format conversion

### Phase 3: Teams Integration (Week 3)
1. Add team/channel enumeration
2. Implement message reading
3. Add message sending

### Phase 4: SharePoint Support (Week 4)
1. Site discovery and search
2. Document library access
3. Integration with file operations

## Testing Strategy

### Unit Tests
- Mock Graph API responses for each endpoint
- Test permission error handling
- Validate request construction

### Integration Tests
```rust
#[test]
fn test_files_list() {
    // Mock /me/drive/root/children response
}

#[test]
fn test_teams_send_message() {
    // Mock POST /teams/{id}/channels/{id}/messages
}
```

### Manual Testing Checklist
- [ ] Verify each scope triggers correct consent
- [ ] Test with personal vs work accounts
- [ ] Validate error messages for missing permissions
- [ ] Test with large result sets (pagination)
- [ ] Verify file upload/download with various formats

## Security Considerations

1. **File Operations**: 
   - Validate file paths to prevent directory traversal
   - Limit file sizes for uploads/downloads
   - Sanitize filenames

2. **Teams Messages**:
   - HTML content sanitization
   - Rate limiting for sends
   - Mention validation

3. **Token Scope**:
   - Minimal scope principle
   - Clear scope documentation
   - Scope validation before operations

## Future Enhancements

### Near-term
- Batch operations for file uploads
- Message threading support
- File sharing and permissions management
- Teams meeting scheduling

### Long-term
- OneNote integration
- Planner/To-Do tasks
- Power Automate triggers
- Graph webhooks for real-time updates
- Interactive mode with command completion

## Backwards Compatibility

All existing commands remain unchanged. New functionality is additive only. Users can continue using the tool for mail/calendar only without adopting new scopes.

## Success Metrics

- All new commands follow existing patterns
- No performance regression for existing commands
- Clean `cargo fmt` and `cargo clippy` output maintained
- Documentation updated for all new commands
- Error messages provide clear remediation steps